#!/usr/bin/env php
<?php
/**
 * Lunar CLI - Point d'entree autonome.
 *
 * Detecte automatiquement si un projet utilise config/cli.json
 * pour charger sa configuration, sinon utilise les commandes internes.
 *
 * @since 1.0.0
 * @author seb@nethttp.net
 */
declare(strict_types=1);

// Detection de la racine du projet depuis le repertoire courant
$projectRoot = getcwd();
while ($projectRoot !== '/') {
    if (file_exists($projectRoot . '/composer.json')) {
        break;
    }
    $projectRoot = dirname($projectRoot);
}

if ($projectRoot === '/') {
    $projectRoot = getcwd();
}

// Recherche de l'autoloader
$autoloadPaths = [
    $projectRoot . '/vendor/autoload.php',         // Autoloader du projet
    __DIR__ . '/../../../autoload.php',            // Installation via Composer (vendor/yrbane/lunar-cli/bin)
    __DIR__ . '/../vendor/autoload.php',           // Developpement local
];

$autoloaderFound = false;

foreach ($autoloadPaths as $autoloadPath) {
    $realPath = realpath($autoloadPath);
    if (false !== $realPath) {
        require $realPath;
        $autoloaderFound = true;
        break;
    }
}

if (!$autoloaderFound) {
    fwrite(STDERR, "Erreur: Impossible de trouver l'autoloader Composer.\n");
    fwrite(STDERR, "Executez 'composer install' pour installer les dependances.\n");
    exit(1);
}

// Si config/cli.json existe, utiliser Console::run()
$configPath = $projectRoot . '/config/cli.json';

if (file_exists($configPath)) {
    exit(\Lunar\Cli\Console::run($projectRoot));
}

// Sinon, utiliser les commandes internes de lunar-cli
use Lunar\Cli\Application;

$app = new Application('Lunar CLI', '1.0.0');
$app->registerCommandsFromDirectory(__DIR__ . '/../src/Command', 'Lunar\\Cli\\Command');

exit($app->run());
